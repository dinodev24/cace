<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="static/css/style.css"/>
    <script src="static/js/d3.v5.min.js"></script>
    <script src="static/js/mpld3.v0.5.10.min.js"></script>
  </head>
  <body>
    <div class="tab">
      <button class="tablinks" onclick="openTab(event, 'Select')" id="SelectTab">Select</button>
      <button class="tablinks" onclick="openTab(event, 'Progress')" id="ProgressTab" disabled>Progress</button>
      <button class="tablinks" onclick="openTab(event, 'Results')" id="ResultsTab" disabled>Results</button>
    </div>

    <br>

    <div id="Select" class="tabcontent">
      <table id="select_table">
        <thead>
          <tr>
            <th>Select</th>
            <th>Param</th>
          </tr>
        </thead>
        <tbody>
          {% for row in data %}
          <tr>
            <td class="checkbox-column">
              <input type="checkbox" name="selected_params" value="{{ row.name }}" />
            </td>
            <td>{{ row.name }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <br>
      <details>
        <summary>Edit Settings</summary>
        <br>
        <table id="settings_table">
          <tbody>
          <tr>
            <td><label for="max_runs">max_runs</label></td>
            <td><input id="max_runs" type="number" /></td>
          </tr>
          <tr>
            <td><label for="run_path">run_path</label></td>
            <td><input id="run_path" type="text" /></td>
          </tr>
          <tr>
            <td><label for="jobs">jobs</label></td>
            <td><input id="jobs" type="number" /></td>
          </tr>
          <tr>
            <td><label for="force">force</label></td>
            <td><input id="force" type="checkbox" /></td>
          </tr>
          <tr>
            <td><label for="noplot">noplot</label></td>
            <td><input id="noplot" type="checkbox" /></td>
          </tr>
          <tr>
              <td><label for="nosim">nosim</label></td>
              <td><input id="nosim" type="checkbox" /></td>
          </tr>
          <tr>
            <td><label for="sequential">sequential</label></td>
            <td><input id="sequential" type="checkbox" /></td>
          </tr>
          <tr>
            <td><label for="netlist_sources">netlist_source</label></td>
            <td>
              <select id="netlist_source" name="netlist_sources">
                <option></option>
                <option value="schematic">schematic</option>
                <option value="layout">layout</option>
                <option value="pex">pex</option>
                <option value="rcx">rcx</option>
                <option value="best">best</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><label for="parallel_parameters">parallel_parameters</label></td>
            <td><input id="parallel_parameters" type="number"></td>
          </tr>
          </tbody>
        </table>
      </details>
      <br>
      <button id="runSelected" onclick="runSimulations(all=false)">Run Selected</button>
      <button id="runAll" onclick="runSimulations(all=true)">Run All</button>
    </div>

    <div id="Progress" class="tabcontent"></div>

    <div id="Results" class="tabcontent"></div>

    <script>
      function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");

        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }

        tablinks = document.getElementsByClassName("tablinks");

        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
      }
      
      function sendData(jsonData) {
        if (DEBUG) {
          console.log(jsonData);
        }

        fetch("/receive_data", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(jsonData)
        })
        .then(response => {
          if (response.status === 200) {
          } else if (DEBUG) {
            console.log("Error: Received status code", response.status);
          }
        })
        .catch(error => {
          if (DEBUG) {
            console.error("Error:", error);
          }
        });
      }

      function runSimulations(all=false) {
        let table = document.getElementById("select_table");
        let selected_params = [];

        for (let i = 1; i < table.rows.length; i++) {
          let row = table.rows[i];
          if (row.cells[0].firstElementChild.checked && !all) {
            selected_params.push(row.cells[0].firstElementChild.getAttribute("value"));
          } else if (all) {
            selected_params.push(row.cells[0].firstElementChild.getAttribute("value"));
          }
        }

        if (selected_params.length > 0) {
          document.getElementById("runAll").disabled = true;
          document.getElementById("runSelected").disabled = true;
          fetch(`/runsim`, {
            method: "POST",
            body: JSON.stringify({
              "selected_params": selected_params,
              "max_runs": document.getElementById("max_runs").value,
              "run_path": document.getElementById("run_path").value,
              "jobs": document.getElementById("jobs").value,
              "force": document.getElementById("force").checked,
              "noplot": document.getElementById("noplot").checked,
              "nosim": document.getElementById("nosim").checked,
              "sequential": document.getElementById("sequential").checked,
              "netlist_source": document.getElementById("netlist_source").value,
              "parallel_parameters": document.getElementById("parallel_parameters").value
            }),
          });
        }
      }

      var DEBUG = "{{DEBUG}}";

      if (DEBUG == "False") {
        DEBUG = false;
      } else {
        DEBUG = true;
      }
      
      const eventSource = new EventSource("/stream");

      eventSource.onmessage = function (event) {
        let data = JSON.parse(event.data);
        if (DEBUG) {
          console.log(data);
        }

        let task = data.task;
        if (task == "close") {
          eventSource.close();
        } else if (task == "start") {
          let outputDiv = document.getElementById(data.param);
          outputDiv.max = data.steps;
        } else if (task == "step") {
          let outputDiv = document.getElementById(data.param);
          outputDiv.value++;
        } else if (task == "end") {
          let outputDiv = document.getElementById("overall_pb");
          outputDiv.value++;

          if (outputDiv.value == outputDiv.max) {
            sendData({ "task": "fetchresults" });
          }
        } else if (task == "progress") {
          document.getElementById("ProgressTab").disabled = false;
          document.getElementById("ProgressTab").click();
          document.getElementById("Progress").innerHTML = data.html;
        } else if (task == "results") {
          const contentDiv = document.getElementById("Results");
          contentDiv.innerHTML = data.summary;
          contentDiv.innerHTML += data.plots;
          document.getElementById("Progress").innerHTML += data.summary;
          const scripts = contentDiv.getElementsByTagName("script");

          for (let script of scripts) {
            eval(script.innerHTML);
          }

          document.getElementById("simresultsbtn").disabled = false;
          document.getElementById("ResultsTab").disabled = false;
          document.getElementById("cancelbtn").disabled = true;
          eventSource.close();
          sendData({ "task": "end_stream" });
        }
      };

      eventSource.onerror = function () {
        console.error("Error occurred while receiving SSE.");
      };

      window.onbeforeunload = function () {
        sendData({ "task": "end_stream" });
      };

      document.getElementById("SelectTab").click();
    </script>
  </body>
</html>
